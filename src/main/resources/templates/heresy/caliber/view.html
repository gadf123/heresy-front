<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="layout/config :: configFragment">
</head>
<body>
<div th:replace="layout/header :: header"></div>
<div class="content agenda-board">
    <div class="container">
        <div style="height:900px">
            <div style="height :50px; padding : 21px; font-size :28px; font-weight: bolder">
                <span style="display :inline-block; width:80%;"} id="articleTitle">

                </span>
                <span style="display :inline-block; width : 15%;
                            font-size : 13px; text-align : right" id="articleTime">

                </span>
            </div>
            <div style="height :485px;
                    padding : 40px">
                <div style="height :150px; font-size: 20px;" id="articleContent">

                </div>
                <div class="row">
                    <div class="col-lg-6 col-xl-6">
                        <div class="card" style="box-shadow: 0px 0px 6px 4px rgba(0, 0, 0, 0.1);">
                            <div class="card-header" style="font-weight: bolder; font-size: 20px;">
                                의견
                            </div>
                            <div class="card-body">
                                <textarea class="form-control"
                                          id="commentContent"
                                          rows="3"
                                          style="resize: none;"
                                          placeholder="의견을 올려주세요">

                                </textarea>
                            </div>
                            <div class="card-footer text-muted">
                                <div style="text-align: right;">
                                    <button class="articleBtn btn btn-outline-secondary btn-sm list_link_to" type="button">
                                        취소
                                    </button>
                                    <button class="articleBtn btn btn-primary btn-sm" type="button" id="writePosiBtn">
                                        찬성
                                    </button>
                                    <button class="articleBtn btn btn-danger btn-sm" type="button" id="writeNegaBtn">
                                        반대
                                    </button>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="debate-wrapper">
                <div class="row no-gutters">
                    <!--찬성-->
                    <div class="col debate-section">
                        <div id="posi-title">
                            <span>찬성</span> | 현재 <span></span>개 의견
                        </div>
                        <div id="posiContent">

                        </div>
                    </div>
                    <!--best-->
                    <div class="col debate-section">
                        <div class="row no-gutters" style="height : 50%;">
                            <div class="col">
                                <div class="row">
                                    <div class="col" id="best-title">
                                        Best
                                    </div>
                                </div>
                                <div id="best-content">
                                    <div class="row debate-content-row">
                                        <div class="col-12">
                                            <div class="row debate-content-title">
                                                <div class="col-12">
                                                    <span>id</span>
                                                    <span id="debate-content-title-date">2018.08.14</span>
                                                </div>
                                            </div>
                                            <div class="row debate-content-body">
                                                <div class="col-8 col-no-padding-right">
                                                    <div class = "debate-content-body-text"
                                                    >너희가 하는게 뭐냐 야이 나븐놈아 야이 나븐놈아 야이 나븐놈아</div>
                                                </div>
                                                <div class="col-4 debate-content-body-buttons" >
                                                    <img th:src="@{/img/blankUp.png}" alt="like">
                                                    <img th:src="@{/img/blankDown.png}" alt="dislike">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row no-gutters" style="height : 50%;">
                            <div id="worst-title">
                                Worst
                            </div>
                            <div id="worst-content">

                            </div>
                        </div>
                    </div>
                    <!--반대-->
                    <div class="col debate-section">
                        <div id="nega-title">
                            <span>반대</span> | 현재 <span></span>개 의견
                        </div>
                        <div id="nega-content">

                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
</body>
<script th:inline="javascript">
    $(document).ready(function(){
        var linkTo = function(event){
            location.href = "/heresy/caliber/rewrite"
        };

        var url = new URL(window.location.href);
        var articleIdx = url.searchParams.get("id");

        var writeComment = function(){
            var _type = this.id.indexOf('Posi') > 0 ? 'P' : 'N';
            var commentData = {
                articleIdx : articleIdx,
                comment : $('#commentContent').val(),
                type : _type
            };
            userModule
                .firebase
                .auth()
                .currentUser
                .getIdToken(true)
                .then(function(firebaseIdToken) {
                    console.log(firebaseIdToken)
                    ajaxCall(
                        '/agendaComment/Write'
                        ,{
                            method : 'post',
                            data : JSON.stringify(commentData),
                            idToken : firebaseIdToken
                        }
                        ,function(data,jqXHR){

                        }
                        ,function(jqXHR){
                            console.log(jqXHR);
                            alert("server error")
                        }
                    )
                })
                .catch(function(error) {
                    // Handle error
                    alert('firebase token getting error')
                });
        };


        var makeCommentView = function(){
            ajaxCall(
                '/agendaComment/selectAll'
                , {data:{articleIdx : articleIdx}}
                , function (data, jqXHR) {

                }
                , function (jqXHR) {
                    alert("server comment return error");
                }
            );
        };

        userModule.init(function(){}).then(function (user) {
            $('.list_link_to').click(function(){
                location.href = '/heresy/caliber/board?page=1'
            });
            ajaxCall(
                '/agendaBoard/getOneArticle'
                , {data:{articleIdx : articleIdx}}
                , function (data, jqXHR) {

                    $('.rewrite_link_to').click(linkTo);
                    $('#articleTitle').text(data.title);

                    $('#articleTime').text(parseDateWithTime(data.createDate));

                    var content = $.parseHTML(data.content);
                    $('#articleContent').append(content);

                    makeCommentView();

                }
                , function (jqXHR) {
                    alert("server view return error");
                }
            );

            $('#writePosiBtn, #writeNegaBtn').click(writeComment);
        });
    });
</script>
</html>